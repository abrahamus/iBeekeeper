{% extends "base.html" %}

{% block title %}Transactions - iBeekeeper{% endblock %}

{% block styles %}
<style>
/* Styling for disabled filter options */
option:disabled {
    color: #999999 !important;
    font-style: italic;
    background-color: #f8f9fa !important;
}

/* Enhanced styling for disabled options */
select option[disabled] {
    color: #999999 !important;
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-ul"></i> Transactions</h1>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="all" {{ 'selected' if status_filter == 'all' }}>All</option>
                        <option value="unreconciled" {{ 'selected' if status_filter == 'unreconciled' or status_filter == 'unmatched' }}>Unreconciled</option>
                        <option value="reconciled" {{ 'selected' if status_filter == 'reconciled' or status_filter == 'coded' }}>Reconciled</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="category_filter" class="form-label">Category</label>
                    <select class="form-select" id="category_filter" name="category_filter">
                        <option value="all" {{ 'selected' if category_filter == 'all' }}>All</option>
                        <option value="revenue" {{ 'selected' if category_filter == 'revenue' }}>Revenue</option>
                        <option value="expense" {{ 'selected' if category_filter == 'expense' }}>Expense</option>
                        <option value="undefined" {{ 'selected' if category_filter == 'undefined' }}>Undefined</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <div class="row g-1">
                        <div class="col-6">
                            <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" 
                                   placeholder="Start date" value="{{ start_date or '' }}">
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" 
                                   placeholder="End date" value="{{ end_date or '' }}">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label for="search" class="form-label">Global Search</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           placeholder="Search description, payee, merchant, payment reference..." value="{{ search_query }}">
                </div>
                
                <div class="col-md-1">
                    <label>&nbsp;</label>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Column Visibility Controls -->
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-eye"></i> Column Visibility</h6>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#columnControls">
                <i class="bi bi-gear"></i> Customize Columns
            </button>
        </div>
        <div class="collapse mt-2" id="columnControls">
            <div class="row g-2">
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-currency" checked onchange="toggleColumn('currency')">
                        <label class="form-check-label" for="col-currency">Currency</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-merchant" onchange="toggleColumn('merchant')">
                        <label class="form-check-label" for="col-merchant">Merchant</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-reference" onchange="toggleColumn('reference')">
                        <label class="form-check-label" for="col-reference">Payment Ref</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-category" onchange="toggleColumn('category')">
                        <label class="form-check-label" for="col-category">Category</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-documents" onchange="toggleColumn('documents')">
                        <label class="form-check-label" for="col-documents">Documents</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-created" onchange="toggleColumn('created')">
                        <label class="form-check-label" for="col-created">Import Date</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mass Actions Bar -->
<div class="card mb-3" id="massActionsCard" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="selectedCount">0</span> transaction(s) selected
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                    <i class="bi bi-check-square"></i> Select All
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectNone()">
                    <i class="bi bi-square"></i> Select None
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                    <i class="bi bi-trash"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-body">
        {% if transactions %}
            <div class="table-responsive">
                <table class="table table-hover" id="transactionsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th class="col-currency">Currency</th>
                            <th>Payee</th>
                            <th class="col-merchant" style="display: none;">Merchant</th>
                            <th class="col-reference" style="display: none;">Payment Reference</th>
                            <th class="col-category" style="display: none;">Category</th>
                            <th>Status</th>
                            <th class="col-documents" style="display: none;">Documents</th>
                            <th class="col-created" style="display: none;">Import Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input transaction-checkbox" 
                                       value="{{ transaction.id }}" onchange="updateSelectedCount()">
                            </td>
                            <td>{{ transaction.date }}</td>
                            <td>
                                <div>{{ transaction.description[:60] }}{% if transaction.description|length > 60 %}...{% endif %}</div>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                    ${{ "%.2f"|format(transaction.amount|abs) }}
                                </span>
                            </td>
                            <td class="col-currency">{{ transaction.currency }}</td>
                            <td>{{ transaction.payee_name or 'N/A' }}</td>
                            <td class="col-merchant" style="display: none;">{{ transaction.merchant or 'N/A' }}</td>
                            <td class="col-reference" style="display: none;">
                                <small>{{ transaction.payment_reference or 'N/A' }}</small>
                            </td>
                            <td class="col-category" style="display: none;">
                                {% if transaction.transaction_code %}
                                    <span class="badge bg-{{ 'success' if transaction.transaction_code.category_name == 'Revenue' else 'danger' }}">
                                        {{ transaction.transaction_code.category_name }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if transaction.is_coded else 'secondary' }}">
                                    {{ transaction.status_display }}
                                </span>
                            </td>
                            <td class="col-documents" style="display: none;">
                                {% if transaction.documents %}
                                    <span class="badge bg-info">{{ transaction.documents|length }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td class="col-created" style="display: none;">
                                <small>{{ transaction.created_at.strftime('%Y-%m-%d') if transaction.created_at else 'N/A' }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('transactions.transaction_detail', transaction_id=transaction.id) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    <a href="{{ url_for('transactions.edit_transaction', transaction_id=transaction.id) }}" 
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    <a href="{{ url_for('transactions.delete_transaction', transaction_id=transaction.id) }}" 
                                       class="btn btn-outline-danger"
                                       onclick="return confirm('Are you sure you want to delete this transaction and all its data?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox display-1"></i>
                <h4 class="mt-3">No transactions found</h4>
                <p>Try adjusting your filters or add new transactions.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Column visibility management
const STORAGE_KEY = 'transactionTableColumns';

// Default column visibility
const defaultColumns = {
    currency: true,
    merchant: false,
    reference: false,
    category: false,
    documents: false,
    created: false
};

// Load saved column preferences or use defaults
function loadColumnPreferences() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : defaultColumns;
    } catch (e) {
        return defaultColumns;
    }
}

// Save column preferences
function saveColumnPreferences(columns) {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(columns));
    } catch (e) {
        console.warn('Failed to save column preferences');
    }
}

// Toggle column visibility
function toggleColumn(columnName) {
    const checkbox = document.getElementById(`col-${columnName}`);
    const isVisible = checkbox.checked;
    
    // Toggle all elements with the column class
    const elements = document.querySelectorAll(`.col-${columnName}`);
    elements.forEach(element => {
        element.style.display = isVisible ? '' : 'none';
    });
    
    // Save preference
    const preferences = loadColumnPreferences();
    preferences[columnName] = isVisible;
    saveColumnPreferences(preferences);
}

// Apply saved column preferences on page load
function applyColumnPreferences() {
    const preferences = loadColumnPreferences();
    
    Object.keys(preferences).forEach(columnName => {
        const checkbox = document.getElementById(`col-${columnName}`);
        const isVisible = preferences[columnName];
        
        if (checkbox) {
            checkbox.checked = isVisible;
            
            // Apply visibility
            const elements = document.querySelectorAll(`.col-${columnName}`);
            elements.forEach(element => {
                element.style.display = isVisible ? '' : 'none';
            });
        }
    });
}

// Clear all filters
function clearFilters() {
    document.getElementById('status').value = 'all';
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    document.getElementById('category_filter').value = 'all';
    document.getElementById('search').value = '';
    
    // Update filter options to re-enable all options
    updateFilterOptions();
    
    // Submit the form to apply the cleared filters
    document.querySelector('form').submit();
}

// Dynamic filter option disabling
function updateFilterOptions() {
    const statusSelect = document.getElementById('status');
    const categorySelect = document.getElementById('category_filter');
    
    const statusValue = statusSelect.value;
    const categoryValue = categorySelect.value;
    
    // Get all option elements
    const statusOptions = statusSelect.querySelectorAll('option');
    const categoryOptions = categorySelect.querySelectorAll('option');
    
    // Reset all options to enabled first
    statusOptions.forEach(option => {
        option.disabled = false;
        option.style.color = '';
        option.title = '';
    });
    categoryOptions.forEach(option => {
        option.disabled = false;
        option.style.color = '';
        option.title = '';
    });
    
    // Apply disabling logic based on current selections
    
    // If status is unreconciled, disable revenue/expense category options
    if (statusValue === 'unreconciled') {
        categoryOptions.forEach(option => {
            if (option.value === 'revenue' || option.value === 'expense') {
                option.disabled = true;
                option.style.color = '#999999';
                option.title = 'Unavailable: Unreconciled transactions cannot have categories';
            }
        });
        
        // If category was set to revenue/expense, reset it to 'all'
        if (categoryValue === 'revenue' || categoryValue === 'expense') {
            categorySelect.value = 'all';
        }
    }
    
    // If status is reconciled, disable undefined category option  
    if (statusValue === 'reconciled') {
        categoryOptions.forEach(option => {
            if (option.value === 'undefined') {
                option.disabled = true;
                option.style.color = '#999999';
                option.title = 'Unavailable: Reconciled transactions must have categories';
            }
        });
        
        // If category was set to undefined, reset it to 'all'
        if (categoryValue === 'undefined') {
            categorySelect.value = 'all';
        }
    }
    
    // If category is revenue or expense, disable unreconciled status option
    if (categoryValue === 'revenue' || categoryValue === 'expense') {
        statusOptions.forEach(option => {
            if (option.value === 'unreconciled') {
                option.disabled = true;
                option.style.color = '#999999';
                option.title = 'Unavailable: Only reconciled transactions can have categories';
            }
        });
        
        // If status was set to unreconciled, reset it to 'all'
        if (statusValue === 'unreconciled') {
            statusSelect.value = 'all';
        }
    }
    
    // If category is undefined, disable reconciled status option
    if (categoryValue === 'undefined') {
        statusOptions.forEach(option => {
            if (option.value === 'reconciled') {
                option.disabled = true;
                option.style.color = '#999999';
                option.title = 'Unavailable: Reconciled transactions must have defined categories';
            }
        });
        
        // If status was set to reconciled, reset it to 'all'
        if (statusValue === 'reconciled') {
            statusSelect.value = 'all';
        }
    }
}

// Mass delete functionality
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selectedCount');
    const massActionsCard = document.getElementById('massActionsCard');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    countElement.textContent = count;
    
    // Show/hide mass actions bar
    if (count > 0) {
        massActionsCard.style.display = 'block';
    } else {
        massActionsCard.style.display = 'none';
        selectAllCheckbox.checked = false;
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
    selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    
    transactionCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedCount();
}

function selectAll() {
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    transactionCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    selectAllCheckbox.checked = true;
    
    updateSelectedCount();
}

function selectNone() {
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    transactionCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    
    updateSelectedCount();
}

function getSelectedTransactionIds() {
    const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
    return Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
}

function deleteSelected() {
    const selectedIds = getSelectedTransactionIds();
    
    if (selectedIds.length === 0) {
        alert('Please select transactions to delete');
        return;
    }
    
    const confirmMessage = `Are you sure you want to delete ${selectedIds.length} transaction(s)? This action cannot be undone and will also delete any associated documents.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Show loading state
    const deleteButton = document.querySelector('[onclick="deleteSelected()"]');
    const originalText = deleteButton.innerHTML;
    deleteButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
    deleteButton.disabled = true;
    
    // Make AJAX request to delete transactions
    fetch('/mass-delete-transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            transaction_ids: selectedIds
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('success', data.message);
            
            // Remove deleted rows from table
            selectedIds.forEach(id => {
                const checkbox = document.querySelector(`.transaction-checkbox[value="${id}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    row.remove();
                }
            });
            
            // Update selected count
            updateSelectedCount();
            
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showAlert('danger', `Network error: ${error.message}`);
    })
    .finally(() => {
        // Restore button state
        deleteButton.innerHTML = originalText;
        deleteButton.disabled = false;
    });
}

function getCsrfToken() {
    // Get CSRF token from meta tag or form
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    
    // Try to get from hidden form input
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    return '';
}

function showAlert(type, message) {
    const alertContainer = document.querySelector('.card-body');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the card body
    alertContainer.insertBefore(alert, alertContainer.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Initialize column preferences and filter options when page loads
document.addEventListener('DOMContentLoaded', function() {
    applyColumnPreferences();
    updateFilterOptions();
    
    // Add event listeners to filter dropdowns
    document.getElementById('status').addEventListener('change', updateFilterOptions);
    document.getElementById('category_filter').addEventListener('change', updateFilterOptions);
});
</script>
{% endblock %}